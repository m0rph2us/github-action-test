name: Test with Gradle

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-with-gradle:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        path: self
    - name: Checkout docker environment repository
      uses: actions/checkout@v2
      with:
        repository: 'm0rph2us/docker-mysql'
        path: 'docker-mysql'
    - name: Checkout proper branch for push event
      if: ${{ github.event_name == 'push' }}
      run: echo $GITHUB_REF && git checkout ${GITHUB_REF##*/}
      working-directory: 'docker-mysql'
    - name: Checkout proper branch for PR event
      if: ${{ github.event_name == 'pull_request' }}
      run: |
        echo $GITHUB_HEAD_REF && echo ${GITHUB_BASE_REF##*/} 
        && git fetch 
        && git branch -a 
        && git checkout $(echo $GITHUB_HEAD_REF | cut -d'/' -f1)/${GITHUB_HEAD_REF##*/} 
        && git merge ${GITHUB_BASE_REF##*/}
      working-directory: 'docker-mysql'
    - name: Run MySQL container
      run: docker-compose up -d
      working-directory: 'docker-mysql'
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: self
    - name: Test with Gradle
      run: ./gradlew :test
      working-directory: self
